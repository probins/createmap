import e from"./draw.htm.js";import t from"./component.js";import{Draw as r,Feature as o,LineString as l,Modify as n,unByKey as a}from"../../deps.js";import i from"../../olMap.js";import s from"../../utils.js";import"./toolbar.js";import u from"../../select.js";import g from"../../vectors.js";import{getLength as d,getArea as c}from"../../measure.js";import{transformCoords as f}from"../../olUtils.js";import m from"./popup.js";let p=i.get();const y=s.$,v=new t(e,"draw");i.addControl(v.getTemplate("draw"));let w,h=m.getOverlay();g.add({vectors:[{id:"Drawn"}]});let C,L=g.getLayers().item(g.getLayers().get("length")-1).get("source"),j=u.get().getFeatures(),S={point:new r({source:L,type:"Point"}),ls:new r({source:L,type:"LineString"}),poly:new r({source:L,type:"Polygon"}),modify:new n({features:j}),split:new n({features:j,deleteCondition:function(){return!1}})};const b=v.getTemplate("featureform");function k(){let e=this.parentNode.querySelector("template"),t=e.content.firstElementChild.cloneNode(!0);y("#featureformAtts").insertBefore(t,e);let r=y("#featureformAtts").querySelectorAll("input");r[r.length-2].focus()}function A(e){let t=h.get("element");for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(b.cloneNode(!0)),y("#featureformid").value="",y("#plusbutton").onclick=k,y("#featurebutton").onclick=function(){y("#featureformid").value&&e.feature.setId(y("#featureformid").value);let r=y("#featureformAtts").querySelectorAll("div");for(let t=0;t<r.length;t++){let o=r[t].querySelectorAll("input");o[0].value&&e.feature.set(o[0].value,o[1].value)}t.style.display="none"},h.set("position",p.get("view").get("center")),t.style.display="block",y("#featureformid").focus(),C&&a(C)}S.point.on("drawend",A),S.ls.on("drawend",A),S.poly.on("drawend",A),S.ls.on("drawstart",(function(e){let t=e.coordinate;C=e.feature.getGeometry().on("change",(function(e){t=e.target.getLastCoordinate();let r=f(e.target,p.get("view").getProjection()),o=d(r);h.get("element").innerHTML=Math.round(.1*o)/100+" km",h.set("position",t),h.get("element").style.display="block"}))})),S.poly.on("drawstart",(function(e){let t=e.coordinate;C=e.feature.getGeometry().on("change",(function(e){t=e.target.getInteriorPoint().getCoordinates();let r=f(e.target,p.get("view").getProjection()),o=c(r);h.get("element").innerHTML=Math.round(o/1e6*100)/100+" km<sup>2</sup>",h.set("position",t),h.get("element").style.display="block"}))})),S.modify.on("modifyend",(function(e){let t=e.features.item(0),r=u.get().getLayer(t);"Drawn"!==r.get("id")&&(r.get("source").removeFeature(t),L.addFeatures([t]),j.clear())}));for(let e in S)p.addInteraction(S[e]),S[e].set("active",!1);let F,T=!1,q=!1;y("#drawtype").onchange=function e(t){j.clear();for(let e in S)S[e].set("active",!1);S[t.target.value]&&S[t.target.value].set("active",!0);"deleet"==t.target.value?(F=j.on("add",(function(e){u.get().getLayer(e.element).get("source").removeFeature(e.element),j.clear()})),T=!0):T&&(a(F),T=!1);"hide"==t.target.value||"choose"==t.target.value?(u.drawOff(),"hide"==t.target.value&&(this.style.display="none",y("#drawoption").style.display="block",y("#drawoption").value="redraw",y("#drawtype").value="choose")):u.drawOn();-1==["point","ls","poly"].indexOf(t.target.value)?u.get().set("active",!0):u.get().set("active",!1);"modAtts"==t.target.value?(F=j.on("add",(function(e){let t=h.get("element");for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(b.cloneNode(!0));let r=e.element;y("#featureformid").value=r.getId();let o=r.getProperties(),l=y("#featureformAtts");for(let e in o)if("geometry"!=e){let t=l.querySelector("template").content.firstElementChild.cloneNode(!0),r=t.querySelectorAll("input");r[0].value=e,r[1].value=o[e],l.insertBefore(t,l.firstElementChild)}y("#plusbutton").onclick=k,y("#featurebutton").onclick=function(){r.setId(y("#featureformid").value);let e=y("#featureformAtts").querySelectorAll("div");for(let t=0;t<e.length;t++){let o=e[t].querySelectorAll("input");o[1].value?r.set(o[0].value,o[1].value):r.unset(o[0].value)}t.style.display="none";let o=u.get().getLayer(r);"Drawn"!==o.get("id")&&(o.get("source").removeFeature(r),L.addFeatures([r]))},h.set("position",p.get("view").get("center")),t.style.display="block"})),q=!0):q&&(a(F),q=!1);"save"!=t.target.value&&"saveall"!=t.target.value||import("./serialise.js").then((function(e){e.default(t.target.value,"Drawn")}));if("split"==t.target.value){let r;u.get().once("select",(function(e){if(e.selected[0]){let t=e.selected[0].getGeometry();t.getType()&&"LineString"==t.getType()?r=t.getCoordinates():t.getType()&&"MultiLineString"==t.getType()&&1===t.getCoordinates().length&&(r=t.getCoordinates()[0])}})),S.split.once("modifyend",(function(n){let a=n.features.item(0);if(!a.getGeometry().getType())return;let i=a.getGeometry().getType(),s=a.getGeometry().getCoordinates();if("MultiLineString"===i){if(1!==s.length)return;s=s[0]}function g(e,t){return e.some((function(e){return t.toString()==e.toString()}))}let d=0;for(;d<s.length&&!0===g(r,s[d]);)d++;let c=s.slice(0,d+1),f=s.slice(d),m=a.getProperties();m.geometry=new l(c);let p=new o(m);m.geometry=new l(f);let y=new o(m);L.addFeatures([p,y]),u.get().getLayer(a).get("source").removeFeature(a),j.clear(),t.target.value="choose",e(t)}))}"join"==t.target.value?w=u.get().on("select",(function(e){if(2==j.get("length")){let e=j.item(0),t=j.item(1),r=e.getProperties();r.geometry=new l(e.getGeometry().getCoordinates().concat(t.getGeometry().getCoordinates().slice(1)));let n=new o(r);j.clear(),u.get().getLayer(t).get("source").removeFeature(t),u.get().getLayer(e).get("source").removeFeature(e),L.addFeatures([n])}})):w&&(a(w),w=null);"clear"==t.target.value&&L.clear();y("#drawtype").blur()},y("#help-content").appendChild(v.getTemplate("drawhelp")),y("#draw-title").addEventListener("click",(function(){let e=this.nextElementSibling;e.style.display="block"==e.style.display?"none":"block"}));