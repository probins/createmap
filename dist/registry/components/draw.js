import e from"./draw.htm.js";import t from"./component.js";var r=new t(e,"draw");import{ol as o}from"../../deps.js";import a from"../../olMap.js";var n=a.get();import i from"../../utils.js";var l=i.$;import"./toolbar.js";let s=r.getTemplate("draw");a.addControl(s);import u from"../../select.js";import g from"../../vectors.js";import{getLength as d,getArea as c}from"../../measure.js";import{transformCoords as f}from"../../olUtils.js";import v from"./popup.js";var m,p=v.getOverlay();g.add({vectors:[{id:"Drawn"}]});var y,w=g.getLayers().item(g.getLayers().get("length")-1).get("source"),h=u.get().getFeatures(),b={point:new o.interaction.Draw({source:w,type:"Point"}),ls:new o.interaction.Draw({source:w,type:"LineString"}),poly:new o.interaction.Draw({source:w,type:"Polygon"}),modify:new o.interaction.Modify({features:h}),split:new o.interaction.Modify({features:h,deleteCondition:function(){return!1}})},C=r.getTemplate("featureform");function L(){var e=this.parentNode.querySelector("template"),t=e.content.firstElementChild.cloneNode(!0);l("#featureformAtts").insertBefore(t,e);var r=l("#featureformAtts").querySelectorAll("input");r[r.length-2].focus()}var S,j=function(e){for(var t=p.get("element");t.firstChild;)t.removeChild(t.firstChild);t.appendChild(C.cloneNode(!0)),l("#featureformid").value="",l("#plusbutton").onclick=L,l("#featurebutton").onclick=function(){l("#featureformid").value&&e.feature.setId(l("#featureformid").value);for(var r=l("#featureformAtts").querySelectorAll("div"),o=0;o<r.length;o++){var a=r[o].querySelectorAll("input");a[0].value&&e.feature.set(a[0].value,a[1].value)}t.style.display="none"},p.set("position",n.get("view").get("center")),t.style.display="block",l("#featureformid").focus(),y&&o.Observable.unByKey(y)};for(S in b.point.on("drawend",j),b.ls.on("drawend",j),b.poly.on("drawend",j),b.ls.on("drawstart",(function(e){var t=e.coordinate;y=e.feature.getGeometry().on("change",(function(e){t=e.target.getLastCoordinate();let r=f(e.target,n.get("view").getProjection()),o=d(r);p.get("element").innerHTML=Math.round(.1*o)/100+" km",p.set("position",t),p.get("element").style.display="block"}))})),b.poly.on("drawstart",(function(e){var t=e.coordinate;y=e.feature.getGeometry().on("change",(function(e){t=e.target.getInteriorPoint().getCoordinates();let r=f(e.target,n.get("view").getProjection()),o=c(r);p.get("element").innerHTML=Math.round(o/1e6*100)/100+" km<sup>2</sup>",p.set("position",t),p.get("element").style.display="block"}))})),b.modify.on("modifyend",(function(e){var t=e.features.item(0),r=u.get().getLayer(t);"Drawn"!==r.get("id")&&(r.get("source").removeFeature(t),w.addFeatures([t]),h.clear())})),b)n.addInteraction(b[S]),b[S].set("active",!1);var k,F=!1,A=!1;l("#drawtype").onchange=function e(t){for(var r in h.clear(),b)b[r].set("active",!1);b[t.target.value]&&b[t.target.value].set("active",!0);"deleet"==t.target.value?(k=h.on("add",(function(e){u.get().getLayer(e.element).get("source").removeFeature(e.element),h.clear()})),F=!0):F&&(o.Observable.unByKey(k),F=!1);"hide"==t.target.value||"choose"==t.target.value?(u.drawOff(),"hide"==t.target.value&&(this.style.display="none",l("#drawoption").style.display="block",l("#drawoption").value="redraw",l("#drawtype").value="choose")):u.drawOn();-1==["point","ls","poly"].indexOf(t.target.value)?u.get().set("active",!0):u.get().set("active",!1);"modAtts"==t.target.value?(k=h.on("add",(function(e){for(var t=p.get("element");t.firstChild;)t.removeChild(t.firstChild);t.appendChild(C.cloneNode(!0));var r=e.element;l("#featureformid").value=r.getId();var o=r.getProperties(),a=l("#featureformAtts");for(var i in o)if("geometry"!=i){var s=a.querySelector("template").content.firstElementChild.cloneNode(!0),g=s.querySelectorAll("input");g[0].value=i,g[1].value=o[i],a.insertBefore(s,a.firstElementChild)}l("#plusbutton").onclick=L,l("#featurebutton").onclick=function(){r.setId(l("#featureformid").value);for(var e=l("#featureformAtts").querySelectorAll("div"),o=0;o<e.length;o++){var a=e[o].querySelectorAll("input");a[1].value?r.set(a[0].value,a[1].value):r.unset(a[0].value)}t.style.display="none";var n=u.get().getLayer(r);"Drawn"!==n.get("id")&&(n.get("source").removeFeature(r),w.addFeatures([r]))},p.set("position",n.get("view").get("center")),t.style.display="block"})),A=!0):A&&(o.Observable.unByKey(k),A=!1);"save"!=t.target.value&&"saveall"!=t.target.value||import("./serialise.js").then((function(e){e.default(t.target.value,"Drawn")}));if("split"==t.target.value){var a;u.get().once("select",(function(e){if(e.selected[0]){var t=e.selected[0].getGeometry();t.getType()&&"LineString"==t.getType()?a=t.getCoordinates():t.getType()&&"MultiLineString"==t.getType()&&1===t.getCoordinates().length&&(a=t.getCoordinates()[0])}})),b.split.once("modifyend",(function(r){var n=r.features.item(0);if(n.getGeometry().getType()){var i=n.getGeometry().getType(),l=n.getGeometry().getCoordinates();if("MultiLineString"===i){if(1!==l.length)return;l=l[0]}for(var s=0;s<l.length&&!0===m(a,l[s]);)s++;var g=l.slice(0,s+1),d=l.slice(s),c=n.getProperties();c.geometry=new o.geom.LineString(g);var f=new o.Feature(c);c.geometry=new o.geom.LineString(d);var v=new o.Feature(c);w.addFeatures([f,v]),u.get().getLayer(n).get("source").removeFeature(n),h.clear(),t.target.value="choose",e(t)}function m(e,t){return e.some((function(e){return t.toString()==e.toString()}))}}))}"join"==t.target.value?m=u.get().on("select",(function(e){if(2==h.get("length")){var t=h.item(0),r=h.item(1),a=t.getProperties();a.geometry=new o.geom.LineString(t.getGeometry().getCoordinates().concat(r.getGeometry().getCoordinates().slice(1)));var n=new o.Feature(a);h.clear(),u.get().getLayer(r).get("source").removeFeature(r),u.get().getLayer(t).get("source").removeFeature(t),w.addFeatures([n])}})):m&&(o.Observable.unByKey(m),m=null);"clear"==t.target.value&&w.clear();l("#drawtype").blur()},l("#help-content").appendChild(r.getTemplate("drawhelp")),l("#draw-title").addEventListener("click",(function(){var e=this.nextElementSibling;e.style.display="block"==e.style.display?"none":"block"}));