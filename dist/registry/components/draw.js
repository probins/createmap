import e from"./draw.htm.js";import t from"./component.js";import{Draw as o,Feature as r,LineString as n,Modify as l,unByKey as a}from"../../deps.js";import s from"../../olMap.js";import{$ as i}from"../../utils.js";import"./toolbar.js";import c from"../../select.js";import g from"../../vectors.js";import{getLength as u,getArea as d}from"../../measure.js";import{transformCoords as m}from"../../olUtils.js";import f from"./popup.js";const p=s.get(),y=new t(e,"draw");s.addControl(y.getTemplate("draw"));const v=f.getOverlay();let w;g.add({vectors:[{id:"Drawn"}]});const h=g.getLayers().item(g.getLayers().get("length")-1).get("source"),C=c.get().getFeatures(),L={point:new o({source:h,type:"Point"}),ls:new o({source:h,type:"LineString"}),poly:new o({source:h,type:"Polygon"}),modify:new l({features:C}),split:new l({features:C,deleteCondition:function(){return!1}})};let j;const S=y.getTemplate("featureform");function b(){const e=this.parentNode.querySelector("template"),t=e.content.firstElementChild.cloneNode(!0);i("#featureformAtts").insertBefore(t,e);const o=i("#featureformAtts").querySelectorAll("input");o[o.length-2].focus()}function k(e){const t=v.get("element");for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(S.cloneNode(!0)),i("#featureformid").value="",i("#plusbutton").onclick=b,i("#featurebutton").onclick=()=>{i("#featureformid").value&&e.feature.setId(i("#featureformid").value);const o=i("#featureformAtts").querySelectorAll("div");for(let t=0;t<o.length;t++){const r=o[t].querySelectorAll("input");r[0].value&&e.feature.set(r[0].value,r[1].value)}t.style.display="none"},v.set("position",p.get("view").get("center")),t.style.display="block",i("#featureformid").focus(),j&&a(j)}L.point.on("drawend",k),L.ls.on("drawend",k),L.poly.on("drawend",k),L.ls.on("drawstart",(e=>{let t=e.coordinate;j=e.feature.getGeometry().on("change",(e=>{t=e.target.getLastCoordinate();const o=m(e.target,p.get("view").getProjection()),r=u(o);v.get("element").innerHTML=Math.round(.1*r)/100+" km",v.set("position",t),v.get("element").style.display="block"}))})),L.poly.on("drawstart",(e=>{let t=e.coordinate;j=e.feature.getGeometry().on("change",(e=>{t=e.target.getInteriorPoint().getCoordinates();const o=m(e.target,p.get("view").getProjection()),r=d(o);v.get("element").innerHTML=Math.round(r/1e6*100)/100+" km<sup>2</sup>",v.set("position",t),v.get("element").style.display="block"}))})),L.modify.on("modifyend",(e=>{const t=e.features.item(0),o=c.get().getLayer(t);"Drawn"!==o.get("id")&&(o.get("source").removeFeature(t),h.addFeatures([t]),C.clear())}));for(const e in L)p.addInteraction(L[e]),L[e].set("active",!1);let A,F=!1,T=!1;i("#drawtype").onchange=function e(t){C.clear();for(const e in L)L[e].set("active",!1);L[t.target.value]&&L[t.target.value].set("active",!0);"deleet"==t.target.value?(A=C.on("add",(e=>{c.get().getLayer(e.element).get("source").removeFeature(e.element),C.clear()})),F=!0):F&&(a(A),F=!1);"hide"==t.target.value||"choose"==t.target.value?(c.drawOff(),"hide"==t.target.value&&(this.style.display="none",i("#drawoption").style.display="block",i("#drawoption").value="redraw",i("#drawtype").value="choose")):c.drawOn();-1==["point","ls","poly"].indexOf(t.target.value)?c.get().set("active",!0):c.get().set("active",!1);"modAtts"==t.target.value?(A=C.on("add",(e=>{const t=v.get("element");for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(S.cloneNode(!0));const o=e.element;i("#featureformid").value=o.getId();const r=o.getProperties(),n=i("#featureformAtts");for(const e in r)if("geometry"!=e){const t=n.querySelector("template").content.firstElementChild.cloneNode(!0),o=t.querySelectorAll("input");o[0].value=e,o[1].value=r[e],n.insertBefore(t,n.firstElementChild)}i("#plusbutton").onclick=b,i("#featurebutton").onclick=()=>{o.setId(i("#featureformid").value);const e=i("#featureformAtts").querySelectorAll("div");for(let t=0;t<e.length;t++){const r=e[t].querySelectorAll("input");r[1].value?o.set(r[0].value,r[1].value):o.unset(r[0].value)}t.style.display="none";const r=c.get().getLayer(o);"Drawn"!==r.get("id")&&(r.get("source").removeFeature(o),h.addFeatures([o]))},v.set("position",p.get("view").get("center")),t.style.display="block"})),T=!0):T&&(a(A),T=!1);"save"!=t.target.value&&"saveall"!=t.target.value||import("./serialise.js").then((e=>e.default(t.target.value,"Drawn")));if("split"==t.target.value){let o;c.get().once("select",(e=>{if(e.selected[0]){const t=e.selected[0].getGeometry();t.getType()&&"LineString"==t.getType()?o=t.getCoordinates():t.getType()&&"MultiLineString"==t.getType()&&1===t.getCoordinates().length&&(o=t.getCoordinates()[0])}})),L.split.once("modifyend",(l=>{const a=l.features.item(0);if(!a.getGeometry().getType())return;const s=a.getGeometry().getType();let i=a.getGeometry().getCoordinates();if("MultiLineString"===s){if(1!==i.length)return;i=i[0]}function g(e,t){return e.some((function(e){return t.toString()==e.toString()}))}let u=0;for(;u<i.length&&!0===g(o,i[u]);)u++;const d=i.slice(0,u+1),m=i.slice(u),f=a.getProperties();f.geometry=new n(d);const p=new r(f);f.geometry=new n(m);const y=new r(f);h.addFeatures([p,y]),c.get().getLayer(a).get("source").removeFeature(a),C.clear(),t.target.value="choose",e(t)}))}"join"==t.target.value?w=c.get().on("select",(e=>{if(2==C.get("length")){const e=C.item(0),t=C.item(1),o=e.getProperties();o.geometry=new n(e.getGeometry().getCoordinates().concat(t.getGeometry().getCoordinates().slice(1)));const l=new r(o);C.clear(),c.get().getLayer(t).get("source").removeFeature(t),c.get().getLayer(e).get("source").removeFeature(e),h.addFeatures([l])}})):w&&(a(w),w=null);"clear"==t.target.value&&h.clear();i("#drawtype").blur()},i("#help-content").appendChild(y.getTemplate("drawhelp")),i("#draw-title").addEventListener("click",(function(){const e=this.nextElementSibling;e.style.display="block"==e.style.display?"none":"block"}));