import t from"./ext/ol.js";import e from"./olMap.js";var r=e.get();import o from"./registry/components/layerswitcher.js";import i from"./utils.js";import a from"./rasters.js";import n from"./mongo.js";var l=i.$,s={normal:{stroke:{color:"rgba(0, 0, 255, 0.6)",width:3},fill:{color:"rgba(255, 255, 255, 0.6)"},image:{radius:7,fillColor:"#ffcc33"}},highlight:{stroke:{color:"rgba(255, 0, 0, 0.6)",width:3},fill:{color:"rgba(255, 0, 0, 0.1)"},image:{radius:7,fillColor:"#ffcc33"}}},c={};["GeoJSON","GPX","KML"].forEach((function(e){c[e]=new t.format[e]})),c.mongo=n;var f={geojson:"GeoJSON",gpx:"GPX",kml:"KML"};function g(t){return c[t]}function d(){return r.getLayers().item(1).get("layers")}function u(t){var e=document.getElementById(t.target.htmlFor)||t.target;this.getLayers().item(1).get("layers").getArray().filter((function(t){return t.getProperties().id==e.value}))[0].set("visible",e.checked)}function m(e){e.vectors.forEach((function(a){var n,c,m=a.url,p={featureProjection:r.get("view").getProjection()},v={attributions:a.attribution||""},x=m||a.filename;x&&!a.format&&(c=x.substring(x.lastIndexOf(".")+1),n=f[c]),(n=a.format||n)&&(v.format=g(n)),a.file?v.features=v.format.readFeatures(a.file,p):m&&(a.strategy&&"bbox"==a.strategy&&(v.strategy=function(t,e){return[t]}),v.loader=function(e,r,o){if(a.strategy&&"bbox"==a.strategy){var l=t.proj.transformExtent(e,o,"EPSG:4326");m=a.url+[[l[0].toFixed(6),l[1].toFixed(6)],[l[2].toFixed(6),l[1].toFixed(6)],[l[2].toFixed(6),l[3].toFixed(6)],[l[0].toFixed(6),l[3].toFixed(6)],[l[0].toFixed(6),l[1].toFixed(6)]].join("],[")+"]]]}}}}"}fetch(m).then((function(t){return"GeoJSON"==n||"mongo"==n?t.json():t.text()})).then((function(t){var e=v.format.readFeatures(t,p);d().getArray().filter((function(t){return t.getProperties().id==a.id}))[0].get("source").addFeatures(e)})).catch((function(){i.errors.fetchFail()}))});var h=new t.source.Vector(v);!0!==a.add||!m||a.strategy&&"bbox"==a.strategy||h.once("change",(function(t){r.get("view").fit(t.target.getExtent())}));var b,w={source:h,id:a.id||m},F={};for(b in s.normal)F[b]=s.normal[b];if(a.style)for(b in a.style)F[b]=a.style[b];s[w.id]=F,w.style=function(t){return y(w.id,t)},d().push(new t.layer.Vector(w)),!0===a.add&&a.file&&r.get("view").fit(h.getExtent());var k=o.addVectorDiv(a);if(k[0].addEventListener("click",u.bind(r)),k[1]){var j=e.components||[];-1==j.indexOf("popup")&&(l("#featuredisplayoption").style.display="block"),-1==j.indexOf("tooltip")&&(l("#tooltipoption").style.display="block")}}))}function y(e,r){var o={width:s[e].stroke.width,color:s[e].stroke.color};Array.isArray(o.color)&&(o.color=r.get(o.color[0])==o.color[1]?o.color[2]:o.color[3]);var i=s[e].image.fillColor;return Array.isArray(i)&&(i=r.get(i[0])==i[1]?i[2]:i[3]),new t.style.Style({stroke:new t.style.Stroke(o),fill:new t.style.Fill(s[e].fill),image:new t.style.Circle({radius:s[e].image.radius,fill:new t.style.Fill({color:i})})})}export default{addInitial:function(t){var o,i,n,s;m(t),t.center||t.zoom?t.rasters&&a.makeActiveLayerVisible():(o=d().getArray(),i=[1/0,1/0,-1/0,-1/0],n=0,s=function(t){var e,s;e=i,(s=t.target.getExtent())[0]<e[0]&&(e[0]=s[0]),s[2]>e[2]&&(e[2]=s[2]),s[1]<e[1]&&(e[1]=s[1]),s[3]>e[3]&&(e[3]=s[3]),++n==o.length&&(r.get("view").fit(i),a.makeActiveLayerVisible(),l("#status").style.display="none")},o.forEach((function(t){t.get("source").once("change",s)}))),t.rasters||e.use4326View()},add:m,getFormat:g,getLayers:d,getStyle:y};